#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ù…Ù† Brave Browser ÙˆØ­ÙØ¸Ù‡Ø§ Ø¨ØµÙŠØºØ© Netscape
"""
import sqlite3
import os
from pathlib import Path
from datetime import datetime, timedelta
import shutil


def find_brave_cookies_db():
    """Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ² ÙÙŠ Brave"""
    # Ù…Ø³Ø§Ø±Ø§Øª Brave Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©
    possible_paths = [
        Path(os.environ.get('LOCALAPPDATA', '')) / 'BraveSoftware' / 'Brave-Browser' / 'User Data' / 'Default' / 'Network' / 'Cookies',
        Path(os.environ.get('LOCALAPPDATA', '')) / 'BraveSoftware' / 'Brave-Browser' / 'User Data' / 'Default' / 'Cookies',
        Path(os.environ.get('APPDATA', '')) / 'brave' / 'User Data' / 'Default' / 'Cookies',
    ]
    
    for path in possible_paths:
        if path.exists():
            print(f"âœ“ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ²: {path}")
            return path
    
    print("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù ÙƒÙˆÙƒÙŠØ² Brave")
    return None


def extract_amazon_cookies(cookies_db_path, output_file='secrets/cookies.txt'):
    """
    Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙˆÙƒÙŠØ² Amazon Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Brave
    
    Args:
        cookies_db_path: Ù…Ø³Ø§Ø± Ù…Ù„Ù Cookies ÙÙŠ Brave
        output_file: Ù…Ø³Ø§Ø± Ù…Ù„Ù Ø§Ù„Ø­ÙØ¸
    """
    try:
        # Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ù…Ø¤Ù‚ØªØ© (Ù„Ø£Ù† Ø§Ù„Ù…Ù„Ù Ù‚Ø¯ ÙŠÙƒÙˆÙ† Ù…Ù‚ÙÙ„)
        temp_db = Path('temp_cookies.db')
        shutil.copy2(cookies_db_path, temp_db)
        
        # Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        conn = sqlite3.connect(str(temp_db))
        cursor = conn.cursor()
        
        # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
        cursor.execute("PRAGMA table_info(cookies)")
        columns = [col[1] for col in cursor.fetchall()]
        print(f"   Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ØªØ§Ø­Ø©: {', '.join(columns)}")
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙˆÙƒÙŠØ² Amazon - Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠØ§Ù‹
        # Chrome/Brave ØªØ³ØªØ®Ø¯Ù…: is_secure Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† secure
        if 'is_secure' in columns:
            secure_col = 'is_secure'
        elif 'secure' in columns:
            secure_col = 'secure'
        else:
            secure_col = '0 as is_secure'
        
        query = f"""
        SELECT host_key, path, {secure_col}, expires_utc, name, value
        FROM cookies
        WHERE host_key LIKE '%amazon%'
        ORDER BY host_key, name
        """
        
        cursor.execute(query)
        cookies = cursor.fetchall()
        
        if not cookies:
            print("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ ÙƒÙˆÙƒÙŠØ² Ù…Ù† Amazon (Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª)")
            print("   ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ Ø³Ø¬Ù„Øª Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ https://www.amazon.com/ Ø£Ùˆ amazon.sa")
            conn.close()
            temp_db.unlink()
            return False
        
        # Ø¹Ø±Ø¶ Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø©
        domains = set(cookie[0] for cookie in cookies)
        print(f"\nâœ“ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ {len(cookies)} ÙƒÙˆÙƒÙŠ Ù…Ù† {len(domains)} Ù†Ø·Ø§Ù‚Ø§Øª Amazon:")
        for domain in sorted(domains):
            count = sum(1 for c in cookies if c[0] == domain)
            print(f"   â€¢ {domain} ({count} cookies)")
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ secrets Ø¥Ù† Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
        output_path = Path(output_file)
        output_path.parent.mkdir(exist_ok=True)
        
        # ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø¨ØµÙŠØºØ© Netscape
        with open(output_path, 'w', encoding='utf-8') as f:
            # Header
            f.write("# Netscape HTTP Cookie File\n")
            f.write("# This file was generated by extract_cookies.py\n")
            f.write(f"# Generated: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write("#\n")
            f.write("# Format: domain\tflag\tpath\tsecure\texpiration\tname\tvalue\n\n")
            
            # ÙƒØªØ§Ø¨Ø© ÙƒÙ„ ÙƒÙˆÙƒÙŠ
            for host_key, path, secure, expires_utc, name, value in cookies:
                # ØªØ­ÙˆÙŠÙ„ Ø§Ù„ÙˆÙ‚Øª Ù…Ù† Chrome format (microseconds since 1601) Ø¥Ù„Ù‰ Unix timestamp
                if expires_utc > 0:
                    # Chrome uses microseconds since 1601-01-01
                    chrome_epoch = datetime(1601, 1, 1)
                    unix_epoch = datetime(1970, 1, 1)
                    delta = (unix_epoch - chrome_epoch).total_seconds()
                    expiration = int((expires_utc / 1000000) - delta)
                else:
                    # Session cookie (no expiration)
                    expiration = 0
                
                # ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø³Ø·Ø± Ø¨ØµÙŠØºØ© Netscape
                flag = 'TRUE' if host_key.startswith('.') else 'FALSE'
                secure_flag = 'TRUE' if secure else 'FALSE'
                
                f.write(f"{host_key}\t{flag}\t{path}\t{secure_flag}\t{expiration}\t{name}\t{value}\n")
        
        # Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø§ØªØµØ§Ù„ ÙˆØ­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¤Ù‚Øª
        conn.close()
        temp_db.unlink()
        
        print(f"\nâœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒÙˆÙƒÙŠØ² ÙÙŠ: {output_path}")
        print(f"   Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆÙƒÙŠØ²: {len(cookies)}")
        
        # Ø¹Ø±Ø¶ Ø£Ù‡Ù… Ø§Ù„ÙƒÙˆÙƒÙŠØ²
        print("\nğŸ“‹ Ø§Ù„ÙƒÙˆÙƒÙŠØ² Ø§Ù„Ù…Ù‡Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:")
        important_cookies = ['session-id', 'session-id-time', 'ubid-main', 'at-main', 'sess-at-main', 'x-main']
        for cookie in cookies:
            name = cookie[4]
            if name in important_cookies:
                print(f"   âœ“ {name}")
        
        return True
        
    except sqlite3.Error as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: {e}")
        return False
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£: {e}")
        return False


def verify_cookies(cookies_file='secrets/cookies.txt'):
    """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ²"""
    try:
        path = Path(cookies_file)
        if not path.exists():
            print(f"âŒ Ø§Ù„Ù…Ù„Ù ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯: {cookies_file}")
            return False
        
        with open(path, 'r', encoding='utf-8') as f:
            lines = f.readlines()
        
        cookie_count = sum(1 for line in lines if line.strip() and not line.startswith('#'))
        
        print(f"\nğŸ” Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„Ù:")
        print(f"   Ø§Ù„Ù…Ø³Ø§Ø±: {path.absolute()}")
        print(f"   Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙˆÙƒÙŠØ²: {cookie_count}")
        
        if cookie_count > 0:
            print(f"   âœ… Ø§Ù„Ù…Ù„Ù ØµØ§Ù„Ø­!")
            
            # Ø¹Ø±Ø¶ Ø£ÙˆÙ„ 3 Ø£Ø³Ø·Ø± (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø³Ø§Ø³Ø©)
            print(f"\nğŸ“„ Ø¹ÙŠÙ†Ø© Ù…Ù† Ø§Ù„Ù…Ù„Ù:")
            actual_cookies = [line for line in lines if line.strip() and not line.startswith('#')]
            for i, line in enumerate(actual_cookies[:3]):
                parts = line.strip().split('\t')
                if len(parts) >= 6:
                    print(f"   {i+1}. Cookie: {parts[5]} (Ù…Ù† {parts[0]})")
            
            if len(actual_cookies) > 3:
                print(f"   ... Ùˆ {len(actual_cookies) - 3} ÙƒÙˆÙƒÙŠØ² Ø£Ø®Ø±Ù‰")
            
            return True
        else:
            print(f"   âŒ Ø§Ù„Ù…Ù„Ù ÙØ§Ø±Øº!")
            return False
        
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚: {e}")
        return False


def main():
    print("="*70)
    print("  ğŸª Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙˆÙƒÙŠØ² Amazon Ù…Ù† Brave Browser")
    print("="*70)
    print()
    
    # 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù Ø§Ù„ÙƒÙˆÙƒÙŠØ²
    print("ğŸ“‚ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ù…Ù„Ù ÙƒÙˆÙƒÙŠØ² Brave...")
    cookies_db = find_brave_cookies_db()
    
    if not cookies_db:
        print("\nâŒ ÙØ´Ù„: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Brave Browser")
        print("\nğŸ’¡ ØªØ£ÙƒØ¯ Ù…Ù†:")
        print("   1. ØªØ«Ø¨ÙŠØª Brave Browser")
        print("   2. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ https://www.amazon.com/")
        print("   3. Ø¥ØºÙ„Ø§Ù‚ Brave Browser Ù‚Ø¨Ù„ ØªØ´ØºÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨Øª")
        return
    
    print()
    
    # 2. Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆÙƒÙŠØ²
    print("ğŸ“¥ Ø§Ø³ØªØ®Ø±Ø§Ø¬ ÙƒÙˆÙƒÙŠØ² Amazon...")
    success = extract_amazon_cookies(cookies_db, output_file='secrets/cookies.txt')
    
    if not success:
        print("\nâŒ ÙØ´Ù„ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆÙƒÙŠØ²")
        return
    
    print()
    
    # 3. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù„Ù
    print("="*70)
    verify_cookies('secrets/cookies.txt')
    
    print()
    print("="*70)
    print("  âœ… ØªÙ… Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!")
    print("="*70)
    print()
    print("ğŸ“Œ Ø§Ù„Ø®Ø·ÙˆØ§Øª Ø§Ù„ØªØ§Ù„ÙŠØ©:")
    print("   1. Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² ÙÙŠ: secrets/cookies.txt")
    print("   2. ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† Ø§Ø®ØªØ¨Ø§Ø± Ø¬Ù„Ø¨ Ø§Ù„Ø£ØºÙ„ÙØ©:")
    print("      python test_amazon_cover.py")
    print()


if __name__ == '__main__':
    main()
